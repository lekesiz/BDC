<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficiaries UI Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 20px;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #1f2937;
        }
        .test-button {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #2563eb;
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .info {
            color: #6b7280;
        }
        .results {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .loading {
            color: #fbbf24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Beneficiaries UI Test</h1>
        
        <div class="test-section">
            <h2>Test List View</h2>
            <button class="test-button" onclick="testListBeneficiaries()">Test List</button>
            <button class="test-button" onclick="testPagination()">Test Pagination</button>
            <button class="test-button" onclick="testSearch()">Test Search</button>
            <button class="test-button" onclick="testFilters()">Test Filters</button>
            <div id="list-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>Test Create/Update</h2>
            <button class="test-button" onclick="testCreateBeneficiary()">Test Create</button>
            <button class="test-button" onclick="testUpdateBeneficiary()">Test Update</button>
            <button class="test-button" onclick="testValidation()">Test Validation</button>
            <div id="crud-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>Test Detail View</h2>
            <button class="test-button" onclick="testDetailView()">Test Detail</button>
            <button class="test-button" onclick="testTrainerAssignment()">Test Trainer Assignment</button>
            <button class="test-button" onclick="testProgress()">Test Progress Tracking</button>
            <div id="detail-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>Test Permissions</h2>
            <select id="role-select">
                <option value="super_admin">Super Admin</option>
                <option value="tenant_admin">Tenant Admin</option>
                <option value="trainer">Trainer</option>
                <option value="student">Student</option>
            </select>
            <button class="test-button" onclick="testRolePermissions()">Test Role Permissions</button>
            <div id="permission-results" class="results"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api';
        let authToken = null;

        // Test credentials for different roles
        const roleCredentials = {
            super_admin: { email: 'admin@bdc.com', password: 'Admin123!' },
            tenant_admin: { email: 'tenant@bdc.com', password: 'Tenant123!' },
            trainer: { email: 'trainer@bdc.com', password: 'Trainer123!' },
            student: { email: 'student@bdc.com', password: 'Student123!' }
        };

        async function loginAs(role) {
            const creds = roleCredentials[role];
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(creds)
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.access_token;
                    return { success: true, message: `Logged in as ${role}` };
                } else {
                    return { success: false, message: data.message || 'Login failed' };
                }
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function testListBeneficiaries() {
            const resultsDiv = document.getElementById('list-results');
            resultsDiv.innerHTML = '<span class="loading">Testing list view...</span>';

            try {
                // Test with super admin
                await loginAs('super_admin');
                
                const response = await fetch(`${API_URL}/beneficiaries/list?page=1&per_page=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    let html = '<span class="success">✓ List retrieved successfully</span>\n';
                    html += `Total beneficiaries: ${data.pagination.total_items}\n`;
                    html += `Current page: ${data.pagination.current_page}\n`;
                    html += `Per page: ${data.pagination.per_page}\n\n`;
                    
                    if (data.items && data.items.length > 0) {
                        html += '<table>';
                        html += '<tr><th>ID</th><th>Name</th><th>Email</th><th>Status</th><th>Trainer</th></tr>';
                        data.items.slice(0, 5).forEach(item => {
                            html += `<tr>
                                <td>${item.id}</td>
                                <td>${item.full_name}</td>
                                <td>${item.email}</td>
                                <td>${item.status}</td>
                                <td>${item.assigned_trainer || 'Not assigned'}</td>
                            </tr>`;
                        });
                        html += '</table>';
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testPagination() {
            const resultsDiv = document.getElementById('list-results');
            resultsDiv.innerHTML = '<span class="loading">Testing pagination...</span>';

            try {
                await loginAs('super_admin');
                
                // Test different pages
                let html = '<span class="success">Testing pagination...</span>\n\n';
                
                for (let page = 1; page <= 3; page++) {
                    const response = await fetch(`${API_URL}/beneficiaries/list?page=${page}&per_page=5`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        html += `Page ${page}: ${data.items.length} items\n`;
                    } else {
                        html += `Page ${page}: <span class="error">Error</span>\n`;
                    }
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testSearch() {
            const resultsDiv = document.getElementById('list-results');
            resultsDiv.innerHTML = '<span class="loading">Testing search...</span>';

            try {
                await loginAs('super_admin');
                
                // Test search functionality
                const searchTerms = ['john', 'test', 'student'];
                let html = '<span class="success">Testing search...</span>\n\n';
                
                for (const term of searchTerms) {
                    const response = await fetch(`${API_URL}/beneficiaries/list?search=${term}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        html += `Search "${term}": ${data.items.length} results\n`;
                    } else {
                        html += `Search "${term}": <span class="error">Error</span>\n`;
                    }
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testFilters() {
            const resultsDiv = document.getElementById('list-results');
            resultsDiv.innerHTML = '<span class="loading">Testing filters...</span>';

            try {
                await loginAs('super_admin');
                
                // Test different filters
                const filters = [
                    { name: 'Active status', params: 'status=active' },
                    { name: 'Inactive status', params: 'status=inactive' },
                    { name: 'With trainer', params: 'has_trainer=true' },
                    { name: 'Without trainer', params: 'has_trainer=false' }
                ];
                
                let html = '<span class="success">Testing filters...</span>\n\n';
                
                for (const filter of filters) {
                    const response = await fetch(`${API_URL}/beneficiaries/list?${filter.params}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        html += `${filter.name}: ${data.items.length} results\n`;
                    } else {
                        html += `${filter.name}: <span class="error">Error</span>\n`;
                    }
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testCreateBeneficiary() {
            const resultsDiv = document.getElementById('crud-results');
            resultsDiv.innerHTML = '<span class="loading">Testing create beneficiary...</span>';

            try {
                await loginAs('super_admin');
                
                const newBeneficiary = {
                    first_name: 'Test',
                    last_name: 'Beneficiary',
                    email: `test${Date.now()}@example.com`,
                    phone: '+1234567890',
                    date_of_birth: '1990-01-01',
                    address: '123 Test Street',
                    city: 'Test City',
                    state: 'Test State',
                    country: 'Test Country',
                    zip_code: '12345',
                    status: 'active'
                };
                
                const response = await fetch(`${API_URL}/beneficiaries`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newBeneficiary)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `<span class="success">✓ Beneficiary created successfully</span>\n` +
                        `ID: ${data.id}\n` +
                        `Name: ${data.full_name}\n` +
                        `Email: ${data.email}`;
                } else {
                    resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testUpdateBeneficiary() {
            const resultsDiv = document.getElementById('crud-results');
            resultsDiv.innerHTML = '<span class="loading">Testing update beneficiary...</span>';

            try {
                await loginAs('super_admin');
                
                // First get a beneficiary to update
                const listResponse = await fetch(`${API_URL}/beneficiaries/list?per_page=1`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const listData = await listResponse.json();
                
                if (listData.items && listData.items.length > 0) {
                    const beneficiary = listData.items[0];
                    
                    const updateData = {
                        first_name: beneficiary.first_name,
                        last_name: beneficiary.last_name + ' Updated',
                        phone: '+9876543210'
                    };
                    
                    const response = await fetch(`${API_URL}/beneficiaries/${beneficiary.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultsDiv.innerHTML = `<span class="success">✓ Beneficiary updated successfully</span>\n` +
                            `ID: ${data.id}\n` +
                            `Name: ${data.full_name}\n` +
                            `Phone: ${data.phone}`;
                    } else {
                        resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                    }
                } else {
                    resultsDiv.innerHTML = '<span class="error">✗ No beneficiaries found to update</span>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testValidation() {
            const resultsDiv = document.getElementById('crud-results');
            resultsDiv.innerHTML = '<span class="loading">Testing validation...</span>';

            try {
                await loginAs('super_admin');
                
                // Test with invalid data
                const invalidData = {
                    first_name: '', // Required field
                    email: 'invalid-email', // Invalid format
                    phone: '123' // Too short
                };
                
                const response = await fetch(`${API_URL}/beneficiaries`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invalidData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    resultsDiv.innerHTML = `<span class="success">✓ Validation working correctly</span>\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${data.message || 'Validation errors'}`;
                } else {
                    resultsDiv.innerHTML = '<span class="error">✗ Validation not working (should have failed)</span>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testDetailView() {
            const resultsDiv = document.getElementById('detail-results');
            resultsDiv.innerHTML = '<span class="loading">Testing detail view...</span>';

            try {
                await loginAs('super_admin');
                
                // Get first beneficiary
                const listResponse = await fetch(`${API_URL}/beneficiaries/list?per_page=1`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const listData = await listResponse.json();
                
                if (listData.items && listData.items.length > 0) {
                    const beneficiaryId = listData.items[0].id;
                    
                    const response = await fetch(`${API_URL}/beneficiaries/${beneficiaryId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultsDiv.innerHTML = `<span class="success">✓ Detail view loaded successfully</span>\n` +
                            `ID: ${data.id}\n` +
                            `Name: ${data.full_name}\n` +
                            `Email: ${data.email}\n` +
                            `Status: ${data.status}\n` +
                            `Trainer: ${data.assigned_trainer || 'Not assigned'}\n` +
                            `Created: ${new Date(data.created_at).toLocaleDateString()}`;
                    } else {
                        resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                    }
                } else {
                    resultsDiv.innerHTML = '<span class="error">✗ No beneficiaries found</span>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testTrainerAssignment() {
            const resultsDiv = document.getElementById('detail-results');
            resultsDiv.innerHTML = '<span class="loading">Testing trainer assignment...</span>';

            try {
                await loginAs('super_admin');
                
                // Get a trainer
                const trainersResponse = await fetch(`${API_URL}/users?role=trainer&per_page=1`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const trainersData = await trainersResponse.json();
                
                // Get a beneficiary
                const beneficiariesResponse = await fetch(`${API_URL}/beneficiaries/list?per_page=1`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const beneficiariesData = await beneficiariesResponse.json();
                
                if (trainersData.items && trainersData.items.length > 0 && 
                    beneficiariesData.items && beneficiariesData.items.length > 0) {
                    
                    const trainerId = trainersData.items[0].id;
                    const beneficiaryId = beneficiariesData.items[0].id;
                    
                    const response = await fetch(`${API_URL}/beneficiaries/${beneficiaryId}/assign-trainer`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ trainer_id: trainerId })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultsDiv.innerHTML = `<span class="success">✓ Trainer assigned successfully</span>\n` +
                            `Beneficiary: ${data.full_name}\n` +
                            `Trainer: ${data.assigned_trainer}`;
                    } else {
                        resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                    }
                } else {
                    resultsDiv.innerHTML = '<span class="error">✗ No trainers or beneficiaries found</span>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testProgress() {
            const resultsDiv = document.getElementById('detail-results');
            resultsDiv.innerHTML = '<span class="loading">Testing progress tracking...</span>';

            try {
                await loginAs('super_admin');
                
                // Get first beneficiary
                const listResponse = await fetch(`${API_URL}/beneficiaries/list?per_page=1`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const listData = await listResponse.json();
                
                if (listData.items && listData.items.length > 0) {
                    const beneficiaryId = listData.items[0].id;
                    
                    const response = await fetch(`${API_URL}/beneficiaries/${beneficiaryId}/progress`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultsDiv.innerHTML = `<span class="success">✓ Progress data loaded</span>\n` +
                            `Overall progress: ${data.overall_progress || 0}%\n` +
                            `Completed evaluations: ${data.completed_evaluations || 0}\n` +
                            `Active programs: ${data.active_programs || 0}\n` +
                            `Last activity: ${data.last_activity || 'None'}`;
                    } else {
                        resultsDiv.innerHTML = `<span class="error">✗ Error: ${data.message || response.statusText}</span>`;
                    }
                } else {
                    resultsDiv.innerHTML = '<span class="error">✗ No beneficiaries found</span>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testRolePermissions() {
            const resultsDiv = document.getElementById('permission-results');
            const role = document.getElementById('role-select').value;
            resultsDiv.innerHTML = `<span class="loading">Testing permissions for ${role}...</span>`;

            try {
                await loginAs(role);
                
                // Test different operations
                const tests = [
                    { name: 'List beneficiaries', url: '/beneficiaries/list', method: 'GET' },
                    { name: 'Create beneficiary', url: '/beneficiaries', method: 'POST', 
                      body: { first_name: 'Test', last_name: 'User', email: 'test@test.com' }},
                    { name: 'Update beneficiary', url: '/beneficiaries/1', method: 'PUT',
                      body: { first_name: 'Updated' }},
                    { name: 'Delete beneficiary', url: '/beneficiaries/1', method: 'DELETE' }
                ];
                
                let html = `<span class="info">Testing as ${role}...</span>\n\n`;
                
                for (const test of tests) {
                    const options = {
                        method: test.method,
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    };
                    
                    if (test.body) {
                        options.body = JSON.stringify(test.body);
                    }
                    
                    try {
                        const response = await fetch(`${API_URL}${test.url}`, options);
                        
                        if (response.ok) {
                            html += `${test.name}: <span class="success">✓ Allowed</span>\n`;
                        } else if (response.status === 403) {
                            html += `${test.name}: <span class="info">⊘ Forbidden (expected)</span>\n`;
                        } else {
                            html += `${test.name}: <span class="error">✗ Error (${response.status})</span>\n`;
                        }
                    } catch (error) {
                        html += `${test.name}: <span class="error">✗ Error</span>\n`;
                    }
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>