<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents UI Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        .document-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .document-info {
            flex: 1;
        }
        .document-actions {
            display: flex;
            gap: 5px;
        }
        .folder-tree {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .folder-item {
            padding: 5px 0;
            cursor: pointer;
        }
        .folder-item.nested {
            margin-left: 20px;
        }
        .folder-item:hover {
            background: #e9ecef;
        }
        .folder-item.selected {
            background: #007bff;
            color: white;
        }
        .filters {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .filters input, .filters select {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .upload-area {
            border: 2px dashed #007bff;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        .file-preview {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .permission-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 12px;
        }
        .tag.category {
            background: #17a2b8;
            color: white;
        }
        .version-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Documents UI Test Page</h1>
        
        <div class="test-section">
            <h3>Authentication</h3>
            <div>
                <input type="text" id="username" placeholder="Username" value="admin">
                <input type="password" id="password" placeholder="Password" value="admin123">
                <button onclick="login()">Login</button>
                <button onclick="logout()">Logout</button>
            </div>
            <div id="authResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Document Upload</h3>
            <div class="upload-area" id="uploadArea">
                <p>Drag and drop files here or click to select</p>
                <input type="file" id="fileInput" multiple style="display: none;">
                <button onclick="document.getElementById('fileInput').click()">Select Files</button>
            </div>
            <div>
                <input type="text" id="documentTitle" placeholder="Document title">
                <select id="documentCategory">
                    <option value="identification">Identification</option>
                    <option value="medical">Medical</option>
                    <option value="education">Education</option>
                    <option value="financial">Financial</option>
                    <option value="legal">Legal</option>
                    <option value="other">Other</option>
                </select>
                <input type="text" id="documentTags" placeholder="Tags (comma separated)">
                <input type="text" id="documentBeneficiaryId" placeholder="Beneficiary ID (optional)">
                <button onclick="uploadDocument()">Upload Document</button>
            </div>
            <div class="progress-bar" id="uploadProgress" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="uploadResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Document List</h3>
            <div class="filters">
                <input type="text" id="searchQuery" placeholder="Search documents...">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="identification">Identification</option>
                    <option value="medical">Medical</option>
                    <option value="education">Education</option>
                    <option value="financial">Financial</option>
                    <option value="legal">Legal</option>
                    <option value="other">Other</option>
                </select>
                <select id="typeFilter">
                    <option value="">All Types</option>
                    <option value="pdf">PDF</option>
                    <option value="doc">Word</option>
                    <option value="image">Images</option>
                    <option value="spreadsheet">Spreadsheets</option>
                </select>
                <input type="date" id="dateFrom" placeholder="From date">
                <input type="date" id="dateTo" placeholder="To date">
                <button onclick="listDocuments()">Search Documents</button>
            </div>
            <div id="listResult" class="result"></div>
            <div id="documentsList"></div>
        </div>

        <div class="test-section">
            <h3>Folder Management</h3>
            <div>
                <input type="text" id="folderName" placeholder="Folder name">
                <input type="text" id="parentFolderId" placeholder="Parent folder ID (optional)">
                <button onclick="createFolder()">Create Folder</button>
                <button onclick="listFolders()">List Folders</button>
            </div>
            <div id="folderResult" class="result"></div>
            <div id="folderTree" class="folder-tree"></div>
        </div>

        <div class="test-section">
            <h3>Document Details</h3>
            <div>
                <input type="text" id="documentId" placeholder="Document ID">
                <button onclick="getDocumentDetails()">Get Details</button>
                <button onclick="downloadDocument()">Download</button>
                <button onclick="previewDocument()">Preview</button>
                <button onclick="deleteDocument()" class="danger">Delete</button>
            </div>
            <div id="detailsResult" class="result"></div>
            <div id="documentPreview" class="file-preview"></div>
        </div>

        <div class="test-section">
            <h3>Document Permissions</h3>
            <div>
                <input type="text" id="permissionDocId" placeholder="Document ID">
                <input type="text" id="permissionUserId" placeholder="User ID">
                <select id="permissionLevel">
                    <option value="view">View Only</option>
                    <option value="edit">Edit</option>
                    <option value="admin">Admin</option>
                </select>
                <button onclick="grantPermission()">Grant Permission</button>
                <button onclick="listPermissions()">List Permissions</button>
            </div>
            <div id="permissionResult" class="result"></div>
            <div id="permissionsList"></div>
        </div>

        <div class="test-section">
            <h3>Document Versions</h3>
            <div>
                <input type="text" id="versionDocId" placeholder="Document ID">
                <button onclick="listVersions()">List Versions</button>
                <button onclick="restoreVersion()">Restore Version</button>
            </div>
            <div id="versionResult" class="result"></div>
            <div id="versionsList"></div>
        </div>

        <div class="test-section">
            <h3>Bulk Operations</h3>
            <div>
                <select id="bulkOperation">
                    <option value="download">Download</option>
                    <option value="move">Move to Folder</option>
                    <option value="archive">Archive</option>
                    <option value="delete">Delete</option>
                </select>
                <input type="text" id="bulkDocIds" placeholder="Document IDs (comma separated)">
                <input type="text" id="bulkFolderId" placeholder="Target folder ID (for move)">
                <button onclick="performBulkOperation()">Execute</button>
            </div>
            <div id="bulkResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Document Templates</h3>
            <div>
                <select id="templateType">
                    <option value="consent">Consent Form</option>
                    <option value="intake">Intake Form</option>
                    <option value="assessment">Assessment Form</option>
                    <option value="report">Report Template</option>
                </select>
                <input type="text" id="templateBeneficiaryId" placeholder="Beneficiary ID">
                <button onclick="generateFromTemplate()">Generate Document</button>
            </div>
            <div id="templateResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Document Search</h3>
            <div>
                <input type="text" id="fullTextSearch" placeholder="Search content...">
                <select id="searchScope">
                    <option value="all">All Documents</option>
                    <option value="user">My Documents</option>
                    <option value="shared">Shared with Me</option>
                </select>
                <button onclick="searchDocuments()">Search</button>
            </div>
            <div id="searchResult" class="result"></div>
            <div id="searchResults"></div>
        </div>

        <div class="test-section">
            <h3>Test Suite</h3>
            <button onclick="runAllTests()">Run All Tests</button>
            <div id="suiteResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let authToken = localStorage.getItem('authToken') || '';
        let selectedFile = null;

        // Authentication
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showResult('authResult', 'Login successful', 'success');
                } else {
                    showResult('authResult', `Login failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('authResult', `Error: ${error.message}`, 'error');
            }
        }

        async function logout() {
            authToken = '';
            localStorage.removeItem('authToken');
            showResult('authResult', 'Logged out', 'success');
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                showResult('uploadResult', `Selected: ${selectedFile.name}`, 'success');
            }
        });

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                selectedFile = e.dataTransfer.files[0];
                showResult('uploadResult', `Selected: ${selectedFile.name}`, 'success');
            }
        });

        // Upload document
        async function uploadDocument() {
            if (!selectedFile) {
                showResult('uploadResult', 'Please select a file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', document.getElementById('documentTitle').value);
            formData.append('category', document.getElementById('documentCategory').value);
            formData.append('tags', document.getElementById('documentTags').value);
            
            const beneficiaryId = document.getElementById('documentBeneficiaryId').value;
            if (beneficiaryId) {
                formData.append('beneficiary_id', beneficiaryId);
            }
            
            // Show progress bar
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            
            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        showResult('uploadResult', `Document uploaded with ID: ${data.id}`, 'success');
                        progressBar.style.display = 'none';
                        selectedFile = null;
                        listDocuments();
                    } else {
                        const data = JSON.parse(xhr.responseText);
                        showResult('uploadResult', `Upload failed: ${data.message}`, 'error');
                        progressBar.style.display = 'none';
                    }
                });
                
                xhr.addEventListener('error', () => {
                    showResult('uploadResult', 'Upload error', 'error');
                    progressBar.style.display = 'none';
                });
                
                xhr.open('POST', `${API_URL}/documents/upload`);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.send(formData);
                
            } catch (error) {
                showResult('uploadResult', `Error: ${error.message}`, 'error');
                progressBar.style.display = 'none';
            }
        }

        // List documents
        async function listDocuments() {
            const params = new URLSearchParams({
                page: 1,
                per_page: 20
            });
            
            const search = document.getElementById('searchQuery').value;
            const category = document.getElementById('categoryFilter').value;
            const type = document.getElementById('typeFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (search) params.append('search', search);
            if (category) params.append('category', category);
            if (type) params.append('type', type);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            
            try {
                const response = await fetch(`${API_URL}/documents/list?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('listResult', `Found ${data.total} documents`, 'success');
                    displayDocuments(data.data);
                } else {
                    showResult('listResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('listResult', `Error: ${error.message}`, 'error');
            }
        }

        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');
            if (!documents || documents.length === 0) {
                container.innerHTML = '<p>No documents found</p>';
                return;
            }
            
            container.innerHTML = documents.map(doc => `
                <div class="document-card">
                    <div class="document-info">
                        <h4>${doc.title}</h4>
                        <p>Type: ${doc.file_type} | Size: ${formatFileSize(doc.file_size)}</p>
                        <p>Uploaded: ${new Date(doc.created_at).toLocaleDateString()}</p>
                        <div>
                            <span class="tag category">${doc.category}</span>
                            ${doc.tags ? doc.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('') : ''}
                        </div>
                    </div>
                    <div class="document-actions">
                        <button onclick="viewDetails('${doc.id}')">View</button>
                        <button onclick="downloadDoc('${doc.id}')">Download</button>
                        <button onclick="deleteDoc('${doc.id}')" class="danger">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Folder management
        async function createFolder() {
            const folderData = {
                name: document.getElementById('folderName').value,
                parent_id: document.getElementById('parentFolderId').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/documents/folders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(folderData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('folderResult', `Folder created with ID: ${data.id}`, 'success');
                    listFolders();
                } else {
                    showResult('folderResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('folderResult', `Error: ${error.message}`, 'error');
            }
        }

        async function listFolders() {
            try {
                const response = await fetch(`${API_URL}/documents/folders`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('folderResult', 'Folders retrieved', 'success');
                    displayFolderTree(data.folders);
                } else {
                    showResult('folderResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('folderResult', `Error: ${error.message}`, 'error');
            }
        }

        function displayFolderTree(folders, parentId = null, level = 0) {
            const container = document.getElementById('folderTree');
            if (level === 0) container.innerHTML = '';
            
            folders.filter(f => f.parent_id === parentId).forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = `folder-item ${level > 0 ? 'nested' : ''}`;
                folderItem.style.marginLeft = `${level * 20}px`;
                folderItem.innerHTML = `📁 ${folder.name}`;
                folderItem.onclick = () => selectFolder(folder.id);
                container.appendChild(folderItem);
                
                // Recursively display children
                displayFolderTree(folders, folder.id, level + 1);
            });
        }

        function selectFolder(folderId) {
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
            showResult('folderResult', `Selected folder: ${folderId}`, 'success');
        }

        // Document details
        async function getDocumentDetails() {
            const documentId = document.getElementById('documentId').value;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('detailsResult', 'Document details retrieved', 'success');
                    displayDocumentDetails(data);
                } else {
                    showResult('detailsResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('detailsResult', `Error: ${error.message}`, 'error');
            }
        }

        function displayDocumentDetails(doc) {
            const container = document.getElementById('documentPreview');
            container.innerHTML = `
                <h4>${doc.title}</h4>
                <p><strong>File Name:</strong> ${doc.file_name}</p>
                <p><strong>Category:</strong> ${doc.category}</p>
                <p><strong>Type:</strong> ${doc.file_type}</p>
                <p><strong>Size:</strong> ${formatFileSize(doc.file_size)}</p>
                <p><strong>Uploaded by:</strong> ${doc.uploaded_by_name}</p>
                <p><strong>Created:</strong> ${new Date(doc.created_at).toLocaleString()}</p>
                <p><strong>Last Modified:</strong> ${new Date(doc.updated_at).toLocaleString()}</p>
                ${doc.beneficiary ? `<p><strong>Beneficiary:</strong> ${doc.beneficiary.first_name} ${doc.beneficiary.last_name}</p>` : ''}
                <div>
                    <strong>Tags:</strong>
                    ${doc.tags ? doc.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('') : 'None'}
                </div>
            `;
        }

        async function downloadDocument() {
            const documentId = document.getElementById('documentId').value;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    // Get filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filenameMatch = contentDisposition && contentDisposition.match(/filename="(.+)"/);
                    const filename = filenameMatch ? filenameMatch[1] : 'document';
                    
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showResult('detailsResult', 'Download started', 'success');
                } else {
                    const data = await response.json();
                    showResult('detailsResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('detailsResult', `Error: ${error.message}`, 'error');
            }
        }

        async function previewDocument() {
            const documentId = document.getElementById('documentId').value;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/preview`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.preview_url) {
                        window.open(data.preview_url, '_blank');
                        showResult('detailsResult', 'Preview opened in new window', 'success');
                    } else {
                        showResult('detailsResult', 'Preview not available', 'warning');
                    }
                } else {
                    const data = await response.json();
                    showResult('detailsResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('detailsResult', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteDocument() {
            const documentId = document.getElementById('documentId').value;
            
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('detailsResult', 'Document deleted successfully', 'success');
                    listDocuments();
                } else {
                    showResult('detailsResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('detailsResult', `Error: ${error.message}`, 'error');
            }
        }

        // Permissions
        async function grantPermission() {
            const permissionData = {
                document_id: document.getElementById('permissionDocId').value,
                user_id: document.getElementById('permissionUserId').value,
                permission_level: document.getElementById('permissionLevel').value
            };
            
            try {
                const response = await fetch(`${API_URL}/documents/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(permissionData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('permissionResult', 'Permission granted', 'success');
                    listPermissions();
                } else {
                    showResult('permissionResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('permissionResult', `Error: ${error.message}`, 'error');
            }
        }

        async function listPermissions() {
            const documentId = document.getElementById('permissionDocId').value;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/permissions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('permissionResult', 'Permissions retrieved', 'success');
                    displayPermissions(data.permissions);
                } else {
                    showResult('permissionResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('permissionResult', `Error: ${error.message}`, 'error');
            }
        }

        function displayPermissions(permissions) {
            const container = document.getElementById('permissionsList');
            if (!permissions || permissions.length === 0) {
                container.innerHTML = '<p>No permissions found</p>';
                return;
            }
            
            container.innerHTML = permissions.map(perm => `
                <div class="permission-item">
                    <div>
                        <strong>${perm.user_name}</strong>
                        <br>Permission: ${perm.permission_level}
                    </div>
                    <button onclick="revokePermission('${perm.id}')" class="danger">Revoke</button>
                </div>
            `).join('');
        }

        async function revokePermission(permissionId) {
            if (!confirm('Are you sure you want to revoke this permission?')) return;
            
            try {
                const response = await fetch(`${API_URL}/documents/permissions/${permissionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('permissionResult', 'Permission revoked', 'success');
                    listPermissions();
                } else {
                    showResult('permissionResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('permissionResult', `Error: ${error.message}`, 'error');
            }
        }

        // Versions
        async function listVersions() {
            const documentId = document.getElementById('versionDocId').value;
            
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/versions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('versionResult', 'Versions retrieved', 'success');
                    displayVersions(data.versions);
                } else {
                    showResult('versionResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('versionResult', `Error: ${error.message}`, 'error');
            }
        }

        function displayVersions(versions) {
            const container = document.getElementById('versionsList');
            if (!versions || versions.length === 0) {
                container.innerHTML = '<p>No versions found</p>';
                return;
            }
            
            container.innerHTML = versions.map(version => `
                <div class="version-item">
                    <strong>Version ${version.version_number}</strong>
                    <br>Created: ${new Date(version.created_at).toLocaleString()}
                    <br>Size: ${formatFileSize(version.file_size)}
                    <br>Uploaded by: ${version.uploaded_by_name}
                    ${version.is_current ? '<br><em>Current version</em>' : ''}
                    ${!version.is_current ? `<button onclick="restoreToVersion('${version.id}')">Restore</button>` : ''}
                </div>
            `).join('');
        }

        async function restoreVersion() {
            const versionId = document.getElementById('versionDocId').value;
            
            if (!confirm('Are you sure you want to restore this version?')) return;
            
            try {
                const response = await fetch(`${API_URL}/documents/versions/${versionId}/restore`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('versionResult', 'Version restored', 'success');
                    listVersions();
                } else {
                    showResult('versionResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('versionResult', `Error: ${error.message}`, 'error');
            }
        }

        // Bulk operations
        async function performBulkOperation() {
            const operation = document.getElementById('bulkOperation').value;
            const documentIds = document.getElementById('bulkDocIds').value.split(',').map(id => id.trim());
            const folderId = document.getElementById('bulkFolderId').value;
            
            const payload = {
                operation,
                document_ids: documentIds
            };
            
            if (operation === 'move') {
                payload.folder_id = folderId;
            }
            
            try {
                const response = await fetch(`${API_URL}/documents/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('bulkResult', `Operation completed: ${data.processed} documents processed`, 'success');
                    listDocuments();
                } else {
                    showResult('bulkResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('bulkResult', `Error: ${error.message}`, 'error');
            }
        }

        // Templates
        async function generateFromTemplate() {
            const templateData = {
                template_type: document.getElementById('templateType').value,
                beneficiary_id: document.getElementById('templateBeneficiaryId').value
            };
            
            try {
                const response = await fetch(`${API_URL}/documents/generate-template`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('templateResult', `Document generated with ID: ${data.document_id}`, 'success');
                    listDocuments();
                } else {
                    showResult('templateResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('templateResult', `Error: ${error.message}`, 'error');
            }
        }

        // Search
        async function searchDocuments() {
            const searchParams = {
                query: document.getElementById('fullTextSearch').value,
                scope: document.getElementById('searchScope').value
            };
            
            try {
                const response = await fetch(`${API_URL}/documents/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchParams)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('searchResult', `Found ${data.results.length} results`, 'success');
                    displaySearchResults(data.results);
                } else {
                    showResult('searchResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('searchResult', `Error: ${error.message}`, 'error');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            if (!results || results.length === 0) {
                container.innerHTML = '<p>No results found</p>';
                return;
            }
            
            container.innerHTML = results.map(result => `
                <div class="document-card">
                    <div class="document-info">
                        <h4>${result.title}</h4>
                        <p>${result.excerpt}</p>
                        <p>Relevance: ${result.relevance_score}%</p>
                    </div>
                    <div class="document-actions">
                        <button onclick="viewDetails('${result.id}')">View</button>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function viewDetails(documentId) {
            document.getElementById('documentId').value = documentId;
            getDocumentDetails();
        }

        function downloadDoc(documentId) {
            document.getElementById('documentId').value = documentId;
            downloadDocument();
        }

        function deleteDoc(documentId) {
            document.getElementById('documentId').value = documentId;
            deleteDocument();
        }

        function restoreToVersion(versionId) {
            document.getElementById('versionDocId').value = versionId;
            restoreVersion();
        }

        // Test suite
        async function runAllTests() {
            const results = [];
            
            // Test 1: Authentication
            results.push(await testAuth());
            
            // Test 2: Document upload
            results.push(await testUpload());
            
            // Test 3: List documents
            results.push(await testList());
            
            // Test 4: Folders
            results.push(await testFolders());
            
            // Test 5: Permissions
            results.push(await testPermissions());
            
            // Test 6: Search
            results.push(await testSearch());
            
            // Display results
            const passed = results.filter(r => r.status === 'pass').length;
            const failed = results.filter(r => r.status === 'fail').length;
            
            const summary = `
                <h4>Test Results: ${passed} passed, ${failed} failed</h4>
                ${results.map(r => `
                    <div class="${r.status === 'pass' ? 'success' : 'error'}">
                        ${r.name}: ${r.message}
                    </div>
                `).join('')}
            `;
            
            document.getElementById('suiteResult').innerHTML = summary;
        }

        // Individual test functions
        async function testAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    return { name: 'Authentication', status: 'pass', message: 'Login successful' };
                } else {
                    return { name: 'Authentication', status: 'fail', message: 'Login failed' };
                }
            } catch (error) {
                return { name: 'Authentication', status: 'fail', message: error.message };
            }
        }

        async function testUpload() {
            try {
                // Create a test file
                const testFile = new File(['Test content'], 'test.txt', { type: 'text/plain' });
                const formData = new FormData();
                formData.append('file', testFile);
                formData.append('title', 'Test Document ' + Date.now());
                formData.append('category', 'other');
                
                const response = await fetch(`${API_URL}/documents/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    return { name: 'Document Upload', status: 'pass', message: 'Upload successful' };
                } else {
                    return { name: 'Document Upload', status: 'fail', message: 'Upload failed' };
                }
            } catch (error) {
                return { name: 'Document Upload', status: 'fail', message: error.message };
            }
        }

        async function testList() {
            try {
                const response = await fetch(`${API_URL}/documents/list?page=1&per_page=10`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    return { name: 'List Documents', status: 'pass', message: 'List retrieved' };
                } else {
                    return { name: 'List Documents', status: 'fail', message: 'List failed' };
                }
            } catch (error) {
                return { name: 'List Documents', status: 'fail', message: error.message };
            }
        }

        async function testFolders() {
            try {
                const response = await fetch(`${API_URL}/documents/folders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'Test Folder ' + Date.now()
                    })
                });
                
                if (response.ok) {
                    return { name: 'Folder Management', status: 'pass', message: 'Folder created' };
                } else {
                    return { name: 'Folder Management', status: 'fail', message: 'Folder creation failed' };
                }
            } catch (error) {
                return { name: 'Folder Management', status: 'fail', message: error.message };
            }
        }

        async function testPermissions() {
            try {
                // First get a document
                const listResponse = await fetch(`${API_URL}/documents/list?page=1&per_page=1`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!listResponse.ok) {
                    return { name: 'Permissions', status: 'fail', message: 'Could not get document list' };
                }
                
                const listData = await listResponse.json();
                if (!listData.data || listData.data.length === 0) {
                    return { name: 'Permissions', status: 'fail', message: 'No documents available' };
                }
                
                const documentId = listData.data[0].id;
                const response = await fetch(`${API_URL}/documents/${documentId}/permissions`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    return { name: 'Permissions', status: 'pass', message: 'Permissions retrieved' };
                } else {
                    return { name: 'Permissions', status: 'fail', message: 'Permissions failed' };
                }
            } catch (error) {
                return { name: 'Permissions', status: 'fail', message: error.message };
            }
        }

        async function testSearch() {
            try {
                const response = await fetch(`${API_URL}/documents/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'test',
                        scope: 'all'
                    })
                });
                
                if (response.ok) {
                    return { name: 'Document Search', status: 'pass', message: 'Search completed' };
                } else {
                    return { name: 'Document Search', status: 'fail', message: 'Search failed' };
                }
            } catch (error) {
                return { name: 'Document Search', status: 'fail', message: error.message };
            }
        }

        // Helper function
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // Initialize
        window.onload = () => {
            if (authToken) {
                showResult('authResult', 'Using saved auth token', 'success');
            }
        };
    </script>
</body>
</html>