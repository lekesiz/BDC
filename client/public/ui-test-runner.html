<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDC UI Test Runner</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">BDC UI Test Runner</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            
            <!-- User Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Select User Role:</label>
                <select id="userSelect" class="w-full p-2 border rounded">
                    <option value="super_admin">Super Admin (admin@bdc.com)</option>
                    <option value="tenant_admin">Tenant Admin (tenant@bdc.com)</option>
                    <option value="trainer">Trainer (trainer@bdc.com)</option>
                    <option value="student">Student (student@bdc.com)</option>
                </select>
            </div>
            
            <!-- Test Actions -->
            <div class="flex gap-4 mb-6">
                <button onclick="performLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Login
                </button>
                <button onclick="testLogout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Test Logout
                </button>
                <button onclick="checkCurrentUser()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Check Current User
                </button>
                <button onclick="navigateToPage()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Navigate to Page
                </button>
            </div>
            
            <!-- Page Navigation -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Navigate to:</label>
                <select id="pageSelect" class="w-full p-2 border rounded">
                    <option value="/dashboard">Dashboard</option>
                    <option value="/portal">Student Portal</option>
                    <option value="/users">Users</option>
                    <option value="/beneficiaries">Beneficiaries</option>
                    <option value="/evaluations">Evaluations</option>
                    <option value="/documents">Documents</option>
                    <option value="/settings">Settings</option>
                </select>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="results" class="space-y-2"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        const APP_BASE = 'http://localhost:5173';
        
        const USERS = {
            super_admin: {
                email: 'admin@bdc.com',
                password: 'Admin123!',
                role: 'super_admin'
            },
            tenant_admin: {
                email: 'tenant@bdc.com',
                password: 'Tenant123!',
                role: 'tenant_admin'
            },
            trainer: {
                email: 'trainer@bdc.com',
                password: 'Trainer123!',
                role: 'trainer'
            },
            student: {
                email: 'student@bdc.com',
                password: 'Student123!',
                role: 'student'
            }
        };
        
        function logResult(message, type = 'info') {
            const results = document.getElementById('results');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            const colorClass = type === 'success' ? 'text-green-600' : 
                             type === 'error' ? 'text-red-600' : 
                             'text-gray-700';
            
            entry.className = `p-2 ${colorClass}`;
            entry.textContent = `[${timestamp}] ${message}`;
            results.insertBefore(entry, results.firstChild);
        }
        
        async function performLogin() {
            const selectedUser = document.getElementById('userSelect').value;
            const user = USERS[selectedUser];
            
            logResult(`Starting login test for ${user.email}...`);
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: user.email,
                        password: user.password,
                        remember_me: false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    
                    logResult(`Login successful! Token: ${data.access_token.substring(0, 20)}...`, 'success');
                    logResult(`User info: ${JSON.stringify(data.user)}`, 'success');
                    
                    // Test redirect behavior
                    const expectedRedirect = user.role === 'student' ? '/portal' : '/dashboard';
                    logResult(`Expected redirect: ${expectedRedirect}`);
                    
                    // Open the application in a new tab
                    window.open(`${APP_BASE}${expectedRedirect}`, '_blank');
                    
                } else {
                    logResult(`Login failed: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                logResult(`Login error: ${error.message}`, 'error');
            }
        }
        
        async function testLogout() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                logResult('No access token found. Please login first.', 'error');
                return;
            }
            
            logResult('Starting logout test...');
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    logResult('Logout successful!', 'success');
                } else {
                    logResult(`Logout failed: ${response.status}`, 'error');
                }
            } catch (error) {
                logResult(`Logout error: ${error.message}`, 'error');
            }
        }
        
        async function checkCurrentUser() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                logResult('No access token found. Please login first.', 'error');
                return;
            }
            
            logResult('Checking current user...');
            
            try {
                const response = await fetch(`${API_BASE}/api/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    logResult(`Current user: ${JSON.stringify(user)}`, 'success');
                } else {
                    logResult(`Failed to get user info: ${response.status}`, 'error');
                }
            } catch (error) {
                logResult(`Error checking user: ${error.message}`, 'error');
            }
        }
        
        function navigateToPage() {
            const selectedPage = document.getElementById('pageSelect').value;
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                logResult('No access token found. Please login first.', 'error');
                return;
            }
            
            logResult(`Navigating to ${selectedPage}...`);
            window.open(`${APP_BASE}${selectedPage}`, '_blank');
        }
        
        // Initial load
        window.onload = () => {
            logResult('UI Test Runner ready!');
            if (localStorage.getItem('access_token')) {
                logResult('Found existing access token', 'info');
                checkCurrentUser();
            }
        };
    </script>
</body>
</html>