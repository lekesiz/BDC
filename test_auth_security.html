<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí BDC Authorization Security Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 3px; }
        .btn-admin { background: #dc3545; color: white; }
        .btn-trainer { background: #ffc107; color: black; }
        .btn-student { background: #28a745; color: white; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .vulnerability { background: #ffebee; border-left: 4px solid #f44336; }
        .secure { background: #e8f5e8; border-left: 4px solid #4caf50; }
    </style>
</head>
<body>
    <h1>üîí BDC Authorization Security Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Login Tests</h2>
        <button class="btn-admin" onclick="loginAs('admin')">Login as Admin</button>
        <button class="btn-trainer" onclick="loginAs('trainer')">Login as Trainer</button>
        <button class="btn-student" onclick="loginAs('student')">Login as Student</button>
        <button onclick="logout()">Logout</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Route Access Tests</h2>
        <button onclick="testRouteAccess()">Test All Routes</button>
        <div id="route-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. API Endpoint Security</h2>
        <button onclick="testAPIEndpoints()">Test API Security</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Role Escalation Tests</h2>
        <button onclick="testRoleEscalation()">Test Role Escalation</button>
        <div id="escalation-result"></div>
    </div>

    <script>
        let currentUser = null;
        let currentToken = null;
        
        // User credentials
        const users = {
            admin: { email: 'admin@bdc.com', password: 'admin123', expectedRole: 'super_admin' },
            trainer: { email: 'trainer@bdc.com', password: 'trainer123', expectedRole: 'trainer' },
            student: { email: 'student@bdc.com', password: 'student123', expectedRole: 'student' }
        };
        
        // Test routes with expected access levels
        const testRoutes = [
            { path: '/', name: 'Dashboard', allowedRoles: ['all'] },
            { path: '/users', name: 'Users Management', allowedRoles: ['super_admin', 'tenant_admin'] },
            { path: '/admin/tenants', name: 'Tenants', allowedRoles: ['super_admin'] },
            { path: '/beneficiaries', name: 'Beneficiaries', allowedRoles: ['super_admin', 'tenant_admin', 'trainer'] },
            { path: '/portal', name: 'Student Portal', allowedRoles: ['student', 'trainee'] },
            { path: '/my-evaluations', name: 'My Evaluations', allowedRoles: ['student', 'trainee'] },
            { path: '/settings', name: 'Settings', allowedRoles: ['all'] }
        ];
        
        // API endpoints to test
        const apiEndpoints = [
            { method: 'GET', path: '/api/users', name: 'List Users', allowedRoles: ['super_admin', 'tenant_admin'] },
            { method: 'GET', path: '/api/beneficiaries', name: 'List Beneficiaries', allowedRoles: ['super_admin', 'tenant_admin', 'trainer'] },
            { method: 'POST', path: '/api/users', name: 'Create User', allowedRoles: ['super_admin', 'tenant_admin'] },
            { method: 'GET', path: '/api/evaluations', name: 'List Evaluations', allowedRoles: ['all'] },
            { method: 'GET', path: '/api/users/me', name: 'Get Profile', allowedRoles: ['all'] }
        ];
        
        async function loginAs(userType) {
            const container = document.getElementById('login-result');
            container.innerHTML = `<div class="info">Logging in as ${userType}...</div>`;
            
            const user = users[userType];
            
            try {
                const response = await fetch('http://localhost:5001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        password: user.password,
                        remember: false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    currentToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('access_token', currentToken);
                    
                    const roleCheck = currentUser.role === user.expectedRole ? 
                        '<span class="success">‚úÖ Role Correct</span>' : 
                        '<span class="error">‚ùå Role Mismatch</span>';
                    
                    container.innerHTML = `
                        <div class="success">‚úÖ Login Successful</div>
                        <div class="info">User: ${currentUser.email}</div>
                        <div class="info">Role: ${currentUser.role} ${roleCheck}</div>
                        <div class="info">Token: ${currentToken.substring(0, 20)}...</div>
                    `;
                } else {
                    container.innerHTML = `<div class="error">‚ùå Login Failed: ${data.message}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Login Error: ${error.message}</div>`;
            }
        }
        
        async function logout() {
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('access_token');
            document.getElementById('login-result').innerHTML = '<div class="info">Logged out</div>';
        }
        
        async function testRouteAccess() {
            const container = document.getElementById('route-result');
            
            if (!currentUser) {
                container.innerHTML = '<div class="error">‚ùå Please login first</div>';
                return;
            }
            
            container.innerHTML = '<div class="info">Testing route access...</div>';
            
            let results = `<h3>Route Access Test Results for ${currentUser.role}:</h3>`;
            let vulnerabilities = 0;
            let secureRoutes = 0;
            
            for (const route of testRoutes) {
                try {
                    const response = await fetch(`http://localhost:5173${route.path}`, {
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    const shouldHaveAccess = route.allowedRoles.includes('all') || 
                                           route.allowedRoles.includes(currentUser.role);
                    
                    const hasAccess = response.ok;
                    
                    if (shouldHaveAccess && hasAccess) {
                        results += `<div class="secure">‚úÖ ${route.name}: Correctly Allowed</div>`;
                        secureRoutes++;
                    } else if (!shouldHaveAccess && !hasAccess) {
                        results += `<div class="secure">‚úÖ ${route.name}: Correctly Blocked</div>`;
                        secureRoutes++;
                    } else if (!shouldHaveAccess && hasAccess) {
                        results += `<div class="vulnerability">üö® ${route.name}: VULNERABILITY - Should be blocked but accessible!</div>`;
                        vulnerabilities++;
                    } else {
                        results += `<div class="error">‚ùå ${route.name}: Blocked but should be accessible</div>`;
                    }
                } catch (error) {
                    results += `<div class="error">‚ùå ${route.name}: Test Error - ${error.message}</div>`;
                }
            }
            
            results += `
                <div style="margin-top: 15px; padding: 10px; background: #f0f0f0;">
                    <strong>Security Summary:</strong><br>
                    ‚úÖ Secure Routes: ${secureRoutes}<br>
                    üö® Vulnerabilities: ${vulnerabilities}<br>
                    ${vulnerabilities === 0 ? '<span class="success">All routes properly secured!</span>' : '<span class="error">Security vulnerabilities detected!</span>'}
                </div>
            `;
            
            container.innerHTML = results;
        }
        
        async function testAPIEndpoints() {
            const container = document.getElementById('api-result');
            
            if (!currentUser) {
                container.innerHTML = '<div class="error">‚ùå Please login first</div>';
                return;
            }
            
            container.innerHTML = '<div class="info">Testing API endpoint security...</div>';
            
            let results = `<h3>API Security Test Results for ${currentUser.role}:</h3>`;
            let apiVulnerabilities = 0;
            let secureEndpoints = 0;
            
            for (const endpoint of apiEndpoints) {
                try {
                    const response = await fetch(`http://localhost:5001${endpoint.path}`, {
                        method: endpoint.method,
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const shouldHaveAccess = endpoint.allowedRoles.includes('all') || 
                                           endpoint.allowedRoles.includes(currentUser.role);
                    
                    const hasAccess = response.ok && response.status !== 403 && response.status !== 401;
                    
                    if (shouldHaveAccess && hasAccess) {
                        results += `<div class="secure">‚úÖ ${endpoint.name}: Correctly Allowed (${response.status})</div>`;
                        secureEndpoints++;
                    } else if (!shouldHaveAccess && !hasAccess) {
                        results += `<div class="secure">‚úÖ ${endpoint.name}: Correctly Blocked (${response.status})</div>`;
                        secureEndpoints++;
                    } else if (!shouldHaveAccess && hasAccess) {
                        results += `<div class="vulnerability">üö® ${endpoint.name}: API VULNERABILITY - Should be blocked but accessible! (${response.status})</div>`;
                        apiVulnerabilities++;
                    } else {
                        results += `<div class="error">‚ùå ${endpoint.name}: Blocked but should be accessible (${response.status})</div>`;
                    }
                } catch (error) {
                    results += `<div class="error">‚ùå ${endpoint.name}: Test Error - ${error.message}</div>`;
                }
            }
            
            results += `
                <div style="margin-top: 15px; padding: 10px; background: #f0f0f0;">
                    <strong>API Security Summary:</strong><br>
                    ‚úÖ Secure Endpoints: ${secureEndpoints}<br>
                    üö® API Vulnerabilities: ${apiVulnerabilities}<br>
                    ${apiVulnerabilities === 0 ? '<span class="success">All API endpoints properly secured!</span>' : '<span class="error">API security vulnerabilities detected!</span>'}
                </div>
            `;
            
            container.innerHTML = results;
        }
        
        async function testRoleEscalation() {
            const container = document.getElementById('escalation-result');
            
            if (!currentUser) {
                container.innerHTML = '<div class="error">‚ùå Please login first</div>';
                return;
            }
            
            container.innerHTML = '<div class="info">Testing role escalation vulnerabilities...</div>';
            
            let results = `<h3>Role Escalation Test Results:</h3>`;
            let escalationAttempts = 0;
            let blockedAttempts = 0;
            
            // Test 1: Token manipulation
            try {
                const fakeAdminToken = currentToken.replace(/.$/, 'X'); // Slightly modify token
                const response = await fetch('http://localhost:5001/api/users', {
                    headers: { 'Authorization': `Bearer ${fakeAdminToken}` }
                });
                
                if (response.ok) {
                    results += `<div class="vulnerability">üö® Token Manipulation: Fake token accepted!</div>`;
                    escalationAttempts++;
                } else {
                    results += `<div class="secure">‚úÖ Token Manipulation: Properly rejected fake token</div>`;
                    blockedAttempts++;
                }
            } catch (error) {
                results += `<div class="secure">‚úÖ Token Manipulation: Properly handled (${error.message})</div>`;
                blockedAttempts++;
            }
            
            // Test 2: Direct API calls without proper role
            if (currentUser.role === 'student') {
                try {
                    const response = await fetch('http://localhost:5001/api/users', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (response.ok) {
                        results += `<div class="vulnerability">üö® Role Bypass: Student can access admin endpoints!</div>`;
                        escalationAttempts++;
                    } else {
                        results += `<div class="secure">‚úÖ Role Protection: Student properly blocked from admin endpoints</div>`;
                        blockedAttempts++;
                    }
                } catch (error) {
                    results += `<div class="secure">‚úÖ Role Protection: Error handling working (${error.message})</div>`;
                    blockedAttempts++;
                }
            }
            
            // Test 3: Cross-tenant access (if applicable)
            try {
                const response = await fetch('http://localhost:5001/api/beneficiaries?tenant_id=999', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                if (response.ok && Array.isArray(data) && data.length > 0) {
                    results += `<div class="vulnerability">üö® Tenant Isolation: May be accessing other tenant data!</div>`;
                    escalationAttempts++;
                } else {
                    results += `<div class="secure">‚úÖ Tenant Isolation: Properly isolated tenant data</div>`;
                    blockedAttempts++;
                }
            } catch (error) {
                results += `<div class="secure">‚úÖ Tenant Isolation: Error handling working</div>`;
                blockedAttempts++;
            }
            
            results += `
                <div style="margin-top: 15px; padding: 10px; background: #f0f0f0;">
                    <strong>Role Escalation Summary:</strong><br>
                    ‚úÖ Blocked Attempts: ${blockedAttempts}<br>
                    üö® Successful Escalations: ${escalationAttempts}<br>
                    ${escalationAttempts === 0 ? '<span class="success">No escalation vulnerabilities found!</span>' : '<span class="error">Role escalation vulnerabilities detected!</span>'}
                </div>
            `;
            
            container.innerHTML = results;
        }
        
        // Auto-check if logged in
        window.onload = function() {
            const token = localStorage.getItem('access_token');
            if (token) {
                document.getElementById('login-result').innerHTML = 
                    '<div class="info">Found existing token. Please re-login to test properly.</div>';
            }
        };
    </script>
</body>
</html>